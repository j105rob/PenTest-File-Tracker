<!DOCTYPE html>
<html lang="en" >
	<head>
		<script type="text/javascript" src="./md5.js"></script>
		<script type="text/javascript">
			var booStorage = false;
			if ( typeof (Storage) !== "undefined") {
				booStorage = true;
			} else {
				alert("Local Storage not available. Data will not be persisted.");
			}
			var clearStorage = function() {
				localStorage.clear();
				objStorage = {};
				document.getElementById('list').innerHTML = "Storage Cleared!!"
			}
			var saveStorage = function() {
				var uriContent = "data:application/octet-stream," + encodeURIComponent(JSON.stringify(objStorage));
				var newWindow = window.open(uriContent, 'The Goods!');
			}
			var objStorage = {};

			var onReady = function() {
				var dropZone = document.getElementById('drop_zone');
				dropZone.addEventListener('dragover', handleDragOver, false);
				dropZone.addEventListener('drop', handleFileSelect, false);
				if (localStorage.objStorage) {
					objStorage = JSON.parse(localStorage.objStorage);
					console.log("Retrieved Storage Obj: ", objStorage);
					outputFormatter();
				}
			}
			function handleFileSelect(evt) {
				evt.stopPropagation();
				evt.preventDefault();
				var files = evt.dataTransfer.files;
				for (var i = 0, f; f = files[i]; i++) {
					var reader = new FileReader();
					reader.onload = (function(theFile) {
						return function(e) {
							storageFormatter({
								data : e.target.result,
								file : theFile
							});
							//outputFormatter(theFile);
						};
					})(f);
					reader.readAsBinaryString(f);
				}
			}

			var storageFormatter = function(obj) {
				var now = Math.round(new Date().getTime() / 1000);
				var hash = hex_md5(obj.data);
				var historyItem = {
					time : now,
					hash : hash,
					fileType : obj.file.type,
					fileSize : obj.file.size,
					fileDate : obj.file.lastModifiedDate ? obj.file.lastModifiedDate.toString() : 'n/a',
					//fileLocation : obj.file.mozFullPath ? obj.file.mozFullPath : "n/a",
					fileData : obj.data
				};
				if (objStorage[obj.file.name] === null || objStorage[obj.file.name] === undefined) {
					var so = {
						fileName : obj.file.name,
						history : []
					};
					so.history.push(historyItem);
					objStorage[obj.file.name] = so;
					outputFormatter();
				} else {
					var so = objStorage[obj.file.name];
					var diff = false;
					for (var i = 0; i < so.history.length; i++) {
						if (so.history[i].hash != hash) {
							diff = true;
							break;
						}
					}
					if (diff) {
						so.history.push(historyItem);
						outputFormatter();
					}
				}
				localStorage.objStorage = JSON.stringify(objStorage);
			}
			var outputFormatter = function() {
				var output = [];
				for (var key in objStorage) {
					output.push('<li><strong>', escape(key), '</strong> <ul>');
					for (var i = 0; i < objStorage[key].history.length; i++) {
						output.push('<li>[', i, "] ", " <strong> Time: </strong>", objStorage[key].history[i].time, " <strong> Last Mod: </strong>", objStorage[key].history[i].fileDate, " <strong> Hash: </strong>", objStorage[key].history[i].hash, " <strong> Type: </strong>", objStorage[key].history[i].fileType, " <strong> Size: </strong>", objStorage[key].history[i].fileSize,

						//" <strong> Local Path: </strong>",objStorage[key].history[i].fileLocation,

						'</li>');
					}
					output.push('</ul></li>');
				}
				document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
			}
			function handleDragOver(evt) {
				evt.stopPropagation();
				evt.preventDefault();
				evt.dataTransfer.dropEffect = 'copy';
			}

			// Dean Edwards/Matthias Miller/John Resig
			function init() {
				// quit if this function has already been called
				if (arguments.callee.done)
					return;

				// flag this function so we don't do the same thing twice
				arguments.callee.done = true;

				// kill the timer
				if (_timer)
					clearInterval(_timer);

				onReady();
			};

			/* for Mozilla/Opera9 */
			if (document.addEventListener) {
				document.addEventListener("DOMContentLoaded", init, false);
			}

			/* for Internet Explorer */
			/*@cc_on @*/
			/*@if (@_win32)
			 document.write("<script id=__ie_onload defer src=javascript:void(0)><\/script>");
			 var script = document.getElementById("__ie_onload");
			 script.onreadystatechange = function() {
			 if (this.readyState == "complete") {
			 init(); // call the onload handler
			 }
			 };
			 /*@end @*/

			/* for Safari */
			if (/WebKit/i.test(navigator.userAgent)) {// sniff
				var _timer = setInterval(function() {
					if (/loaded|complete/.test(document.readyState)) {
						init();
						// call the onload handler
					}
				}, 10);
			}

			/* for other browsers */
			window.onload = init;
		</script>
	</head>
	<body>
		<p>
			PenTest File Tracker v0.0.1a
		</p>

		<div>
			<div id="drop_zone" style="width:150px;border:1px dashed black;">
				<p style="text-align: center">Drop files here</p>
			</div>
			<div>
				<br/>
				<button id="clear" title="Click here to clear out the storage" onclick="clearStorage();">
					Clear Storage
				</button>
				<button id="clear" title="Click here to Download the File List" onclick="saveStorage();">
					Show Me the Goods
				</button>
			</div>
			<output id="list" style="font-size:10pt;"></output>
		</div>

	</body>

